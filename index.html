<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title is set dynamically via JavaScript for the typing animation -->
    <title>Texversa</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SPOT 4: Firebase Imports (Firestore & Auth) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Also import setLogLevel for debugging
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Global variables for Firebase access (stored on window)
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken,
            getFirestore, doc, getDoc, setDoc, updateDoc, increment, runTransaction,
            setLogLevel
        };
    </script>

    <!-- Configure Tailwind for the dark, pink-accent theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#0A0A0A',  // Main background black
                        'card-dark': '#1A1A1A',     // Dark gray for card body
                        'accent-hot-pink': '#FF69B4',    // Hot Pink for accents (high contrast)
                        'accent-gray': '#E0E0E0',   // Light gray for text
                        'status-light-pink': '#FFB6C1'   // Light Pink for online status glow
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        // Sharp, aggressive pink glow
                        'glitch': '0 0 10px #FF69B4, 0 0 20px rgba(255, 105, 180, 0.5), 0 0 30px rgba(255, 105, 180, 0.3)',
                    }
                }
            }
        }
    </script>
    <!-- Custom CSS for background and the floating music button -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* The image background for the whole page */
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: 100% 100%; 
            background-position: center;
            filter: brightness(0.4) contrast(1.5);
            z-index: -2;
        }

        /* Custom style for link buttons */
        .link-button {
            transition: all 0.2s;
            box-shadow: 0 0 5px rgba(255, 105, 180, 0.5);
        }

        .link-button:hover {
            box-shadow: 0 0 15px #FF69B4;
            transform: translateY(-2px);
        }

        /* Custom style for the fixed message box (replacing alert) */
        #message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }
        
        /* Hidden YouTube Iframe for Background Music */
        #youtube-player {
            position: fixed;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
            z-index: -10;
        }

        /* NEW: Floating Music Button Position */
        #floating-music-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 40;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        #floating-music-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #FF69B4;
        }
    </style>
</head>
<body class="bg-primary-dark flex items-center justify-center min-h-screen p-4 font-sans relative">

    <!-- Background Image Container -->
    <div id="background-container"></div>
    
    <!-- Floating Particles Container -->
    <div id="particles-container" class="absolute inset-0 z-[-1]"></div>
    
    <!-- NEW: Floating Music Toggle Button -->
    <button id="floating-music-toggle" class="p-3 bg-accent-hot-pink hover:bg-pink-400 text-primary-dark rounded-full flex items-center justify-center shadow-glitch">
        <!-- Icon will be dynamically set by JS (Play/Pause SVG paths) -->
        <svg id="music-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" viewBox="0 0 24 24">
            <!-- Initial icon path will be set in JS (Play icon) -->
            <path d="M8 5v14l11-7z"/>
        </svg>
    </button>

    <!-- SPOT 2: Background Music YouTube Iframe (Hidden) -->
    <iframe 
        id="youtube-player" 
        src="https://www.youtube.com/embed/lSD_L-xic9o?enablejsapi=1&autoplay=1&loop=1&playlist=lSD_L-xic9o&controls=0&modestbranding=1&rel=0" 
        frameborder="0" 
        allow="autoplay; encrypted-media" 
        allowfullscreen>
    </iframe>
    
    <!-- Message Box for notifications (e.g., music start success/failure) -->
    <div id="message-box" class="p-3 bg-card-dark text-accent-gray rounded-lg shadow-glitch border border-accent-hot-pink/50 transition-opacity duration-300 opacity-0 pointer-events-none"></div>

    <!-- Main Profile Card -->
    <div id="profile-card" class="relative w-full max-w-sm mx-auto p-6 md:p-8 bg-card-dark/90 backdrop-blur-md rounded-lg shadow-glitch border border-accent-hot-pink/50 transition-all duration-300">
        
        <!-- Large Profile Image -->
        <div class="flex justify-center mb-6">
            <div class="relative w-32 h-32 rounded-full p-1 bg-gradient-to-tr from-gray-700 to-accent-hot-pink shadow-glitch">
                <img id="main-profile-pic" src="https://cdn.discordapp.com/avatars/758739147443273789/4359991daaba7fe3adab2ed03ad108c4.png" alt="Profile Picture" class="w-full h-full object-cover rounded-full filter brightness-125 contrast-150" onerror="handleImageError(this)">
                <div class="absolute inset-0 rounded-full border-2 border-accent-hot-pink/40"></div>
            </div>
        </div>

        <!-- Username (Main Static Title - ALL CAPS) -->
        <div class="text-center mb-4">
            <span id="profile-name" class="text-4xl font-black text-accent-hot-pink tracking-widest drop-shadow-xl">TEXVERSA</span>
        </div>

        <!-- State/Status Emoji -->
        <div class="text-center mb-8">
            <span id="state-emoji" class="text-4xl" role="img" aria-label="Status">ðŸ’–</span>
        </div>

        <!-- Small Status Block (Online/Offline indicator) -->
        <div class="flex justify-center mb-10">
            <div class="flex items-center space-x-3 p-3 bg-black/40 border border-accent-hot-pink/20 rounded-full shadow-inner">
                <!-- Small Profile Image -->
                <img id="mini-profile-pic" src="https://cdn.discordapp.com/avatars/758739147443273789/4359991daaba7fe3adab2ed03ad108c4.png" alt="Mini Profile" class="w-10 h-10 object-cover rounded-full filter brightness-125 contrast-150" onerror="handleImageError(this)">
                
                <div class="text-left">
                    <div class="flex items-center space-x-2">
                        <span id="mini-profile-name" class="text-sm font-semibold text-accent-gray">TEXVERSA</span>
                        <!-- Online Status Indicator (Now Light Pink) -->
                        <div class="w-2 h-2 bg-status-light-pink rounded-full shadow-lg shadow-status-light-pink/60 animate-pulse"></div>
                    </div>
                    <span id="last-seen-time" class="text-xs text-status-light-pink">ðŸ’—H O P E</span>
                </div>
            </div>
        </div>
        
        <!-- SPOT 3: Link Buttons Container -->
        <div id="link-buttons-container" class="space-y-4 mb-4">
            <!-- Dynamic Link Buttons will be injected here by JavaScript -->
        </div>

        <!-- View Count Footer -->
        <div class="absolute bottom-4 left-4 flex items-center space-x-1 text-gray-500 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span id="view-count">Loading...</span>
        </div>
    </div>
    
    <!-- Load the YouTube Iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="module">
        // Global variables for Firebase access (stored on window)
        // window.firebase, window.db, window.auth, window.userId are initialized in initializeApp()
        
        // --- YouTube Player Globals ---
        let player;
        // The music button now references the floating element
        const musicButton = document.getElementById('floating-music-toggle'); 
        const musicIcon = document.getElementById('music-icon');

        let isPlaying = false; 
        
        // Function to set the icon based on playback state (SVG paths)
        function setMusicIcon(isCurrentlyPlaying) {
            // Play icon (triangle)
            const playPath = "M8 5v14l11-7z"; 
            // Pause icon (two vertical bars)
            const pausePath = "M6 19h4V5H6v14zm8-14v14h4V5h-4z"; 
            
            musicIcon.innerHTML = `<path d="${isCurrentlyPlaying ? pausePath : playPath}"/>`;
        }
        
        // This function is called automatically by the YouTube Iframe API script
        window.onYouTubeIframeAPIReady = function() {
            const iframe = document.getElementById('youtube-player');
            if (iframe) {
                player = new YT.Player('youtube-player', {
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
            } else {
                console.error("YouTube iframe element not found.");
            }
        };

        function onPlayerReady(event) {
            console.log("YouTube Player is ready.");
            
            // Due to browser autoplay restrictions, we must start it muted and paused.
            // Start muted video in the background but keep it paused initially until the user clicks
            event.target.mute();
            // Start playing only to load the video and handle the unMute/Play logic on click
            event.target.playVideo(); 
            event.target.pauseVideo(); 
            
            // Initialize icon to 'Play' 
            setMusicIcon(false); // Player is technically playing, but muted and considered 'paused' for UX
        }
        
        // Function to handle player state changes (like playing, paused, ended)
        function onPlayerStateChange(event) {
            // Only update state if the user has explicitly clicked the button (unmuted/muted)
            if (!player) return;

            const isCurrentlyUnmuted = player.isMuted() === false;
            
            // The UX logic: If the video is playing AND unmuted, we show 'Pause' icon (isPlaying=true).
            // If the video is muted or paused, we show 'Play' icon (isPlaying=false).
            isPlaying = (event.data === YT.PlayerState.PLAYING && isCurrentlyUnmuted);
            
            setMusicIcon(isPlaying);

            // Manual loop check (in case loop=1 fails or is interrupted)
            if (event.data === YT.PlayerState.ENDED) { 
                 player.seekTo(0);
                 if (isCurrentlyUnmuted) {
                    player.playVideo();
                 }
            }
        }

        function onPlayerError(event) {
            console.error("YouTube Player Error:", event.data);
            showUserMessage("Music playback failed. (Error code: " + event.data + ")", true);
        }
        
        // Event listener to toggle music on button click
        musicButton.addEventListener('click', () => {
            if (!player) {
                 showUserMessage("Music player not yet initialized.", true);
                 return;
            }
            
            try {
                if (player.isMuted() === false) {
                    // It is currently playing (unmuted), so pause/mute it
                    player.mute();
                    player.pauseVideo();
                    isPlaying = false;
                    showUserMessage("Music paused.");
                } else {
                    // It is currently muted/paused, so unmute/play it
                    player.unMute();
                    player.playVideo();
                    isPlaying = true;
                    showUserMessage("Music started successfully!");
                }
                setMusicIcon(isPlaying);
            } catch (e) {
                console.error("Failed to toggle music:", e);
                showUserMessage("Could not toggle music. Try clicking again.", true);
            }
        });
        
        // --- Core Application Logic (Rest of the previous code) ---

        // Display user message in a fixed box (replacing alert/confirm)
        function showUserMessage(message, isError = false) {
            document.getElementById('message-box').textContent = message;
            document.getElementById('message-box').className = `p-3 text-sm rounded-lg shadow-xl transition-opacity duration-300 opacity-100 pointer-events-auto ${isError ? 'bg-red-900 text-accent-hot-pink border border-accent-hot-pink' : 'bg-card-dark text-status-light-pink border border-status-light-pink'}`;
            
            setTimeout(() => {
                document.getElementById('message-box').classList.add('opacity-0');
                document.getElementById('message-box').classList.remove('pointer-events-auto');
            }, 5000);
        }
        
        // === TITLE TYPING ANIMATION LOGIC (RE-IMPLEMENTED) ===
        const titleText = "Texversa";
        let titleIndex = 0;
        let isDeleting = false;
        
        function startTitleTypingAnimation() {
            const titleElement = document.querySelector('title');
            let currentText = titleElement.textContent;

            if (isDeleting) {
                // Delete one character
                currentText = currentText.substring(0, currentText.length - 1);
            } else {
                // Type one character
                currentText = titleText.substring(0, titleIndex + 1);
            }

            titleElement.textContent = currentText;

            // Determine next state
            let typeSpeed = 150; // Speed when typing

            if (isDeleting) {
                typeSpeed = 100; // Speed when deleting
                if (currentText === '') {
                    isDeleting = false;
                    titleIndex = 0;
                    typeSpeed = 500; // Pause before starting to type again
                }
            } else {
                if (currentText === titleText) {
                    isDeleting = true;
                    typeSpeed = 2000; // Pause before deleting starts
                } else {
                    titleIndex++;
                }
            }

            // Loop the function
            setTimeout(startTitleTypingAnimation, typeSpeed);
        }
        // === END TITLE TYPING ANIMATION LOGIC ===


        // View Count Logic
        async function incrementViewCount() {
            if (!window.db) {
                document.getElementById('view-count').textContent = 'Offline'; 
                return;
            }
            
            const viewDocRef = window.firebase.doc(window.db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'profileViews', 'main-profile-views');

            try {
                await window.firebase.runTransaction(window.db, async (transaction) => {
                    const viewDoc = await transaction.get(viewDocRef);
                    
                    if (viewDoc.exists()) {
                        transaction.update(viewDocRef, { count: viewDoc.data().count + 1 });
                        document.getElementById('view-count').textContent = (viewDoc.data().count + 1).toLocaleString();
                    } else {
                        transaction.set(viewDocRef, { count: 1, createdBy: window.userId });
                        document.getElementById('view-count').textContent = 1;
                    }
                });
            } catch (e) {
                console.error("View count update failed:", e);
                document.getElementById('view-count').textContent = 'Error';
            }
        }
        
        // Function to generate and render link buttons
        function renderLinks() {
            document.getElementById('link-buttons-container').innerHTML = ''; 
            
            document.getElementById('link-buttons-container').insertAdjacentHTML('beforeend', `
                <a href="https://discord.gg/Bn3SJTpwJF" target="_blank" rel="noopener noreferrer" class="link-button flex items-center justify-center w-full p-4 bg-accent-hot-pink/10 text-accent-gray font-semibold rounded-lg border border-accent-hot-pink/50 hover:bg-accent-hot-pink/20">
                    <div class="w-6 h-6 mr-3 flex items-center justify-center">
                        <img src="https://cdn.discordapp.com/icons/1340879717464670279/716de26a08eab9887944ae5ecc21d6f7.png?size=512" alt="Cali RP Logo" onerror="handleImageError(this, 'CR')" class="w-6 h-6 object-contain rounded-full">
                    </div>
                    <span>Cali RP</span>
                </a>
                <a href="https://www.roblox.com/users/1515085030/profile" target="_blank" rel="noopener noreferrer" class="link-button flex items-center justify-center w-full p-4 bg-accent-hot-pink/10 text-accent-gray font-semibold rounded-lg border border-accent-hot-pink/50 hover:bg-accent-hot-pink/20">
                    <div class="w-6 h-6 mr-3 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-accent-hot-pink" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect>
                            <circle cx="12" cy="12" r="4"></circle>
                        </svg>
                    </div>
                    <span>My Roblox Profile</span>
                </a>
                <a href="https://www.roblox.com/games/127099328892274/Last-Stand" target="_blank" rel="noopener noreferrer" class="link-button flex items-center justify-center w-full p-4 bg-accent-hot-pink/10 text-accent-gray font-semibold rounded-lg border border-accent-hot-pink/50 hover:bg-accent-hot-pink/20">
                    <div class="w-6 h-6 mr-3 flex items-center justify-center">
                        <img src="https://static.wikia.nocookie.net/roblox/images/4/4d/BlueRobloxLogo.png/revision/latest/scale-to-width-down/250?cb=20250626184501" alt="Roblox Game Logo" onerror="handleImageError(this, 'LS')" class="w-6 h-6 object-contain rounded-md">
                    </div>
                    <span>Play Last Stand</span>
                </a>
            `);
        }

        // Function to update the UI based on static profile data
        const updateUI = () => {
            const discordAvatarUrl = "https://cdn.discordapp.com/avatars/758739147443273789/4359991daaba7fe3adab2ed03ad108c4.png"; 

            document.getElementById('profile-name').textContent = "TEXVERSA"; 
            document.getElementById('mini-profile-name').textContent = "TEXVERSA";
            document.getElementById('state-emoji').textContent = "ðŸ’–";
            document.getElementById('last-seen-time').textContent = "ðŸ’—H O P E";
            
            // Set image sources here to prevent the placeholder from flashing
            document.getElementById('main-profile-pic').src = discordAvatarUrl;
            document.getElementById('mini-profile-pic').src = discordAvatarUrl;

            document.getElementById('background-container').style.backgroundImage = `url('${discordAvatarUrl}')`;
        };
        
        // Function to handle image loading errors (fallbacks to a simple placeholder)
        window.handleImageError = (imgElement, defaultText = 'PFP') => {
            imgElement.src = `https://placehold.co/${imgElement.width || (imgElement.id === 'main-profile-pic' ? 120 : 40)}x${imgElement.height || (imgElement.id === 'main-profile-pic' ? 120 : 40)}/FF69B4/000000?text=${defaultText}`;
            console.error("Image failed to load:", imgElement.src);
            
            if (imgElement.id === 'main-profile-pic') {
                showUserMessage(`Error loading profile image. Displaying placeholder.`, true);
            }
        };

        // Initialize Firebase services
        async function initializeApp() {
            // Enable Firestore debug logging
            if (window.firebase && window.firebase.setLogLevel) {
                window.firebase.setLogLevel('Debug');
            }

            try {
                // FIX: Check if __firebase_config is a valid JSON string before parsing
                const configString = typeof __firebase_config === 'string' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(configString);

                // If the config object is empty (no apiKey), skip full initialization, 
                // but still allow the app to run in offline mode.
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.warn("Firebase config not available. Running in offline/anonymous mode.");
                    document.getElementById('view-count').textContent = 'Offline';
                    return; // Stop initialization
                }
                
                window.app = window.firebase.initializeApp(firebaseConfig);
                window.db = window.firebase.getFirestore(window.app);
                window.auth = window.firebase.getAuth(window.app);
                
                if (typeof __initial_auth_token !== 'undefined') {
                    await window.firebase.signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("Firebase: Authenticated with custom token.");
                } else {
                    await window.firebase.signInAnonymously(window.auth);
                    console.log("Firebase: Signed in anonymously.");
                }
                window.userId = window.auth.currentUser?.uid || crypto.randomUUID();

                // If initialization succeeds, proceed to increment view count
                incrementViewCount();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showUserMessage("Error: Could not connect to the database. View count may not update. Check console for details.", true); 
                document.getElementById('view-count').textContent = 'Error';
            }
        }

        // Initialize everything on load
        window.onload = async () => {
            // NOTE: updateUI and renderLinks are called before initializeApp
            // so the profile card looks complete while Firebase connects in the background.
            updateUI();
            renderLinks();
            await initializeApp(); // Initialize global Firebase instances and attempts auth/view count
            
            // Start the title animation after everything else
            startTitleTypingAnimation(); 
        };

    </script>
</body>
</html>
